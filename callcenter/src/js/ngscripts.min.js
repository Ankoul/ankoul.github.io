var sample=angular.module("sample",["sdk"]),appId="8130a370df1011e983211d565600d8c5",appSecret="Fz7a31012rBhrYAdKGMUVr2VyDZ9Ri53UBYEaKGFr21ajEavXlicHQ4RGHHI1ffq";function extractRainbowAppAuth(e){var n=atob(e.replace("Basic ","")).split(":")[1],t=window.sha256(appSecret+n);return btoa(appId+":"+t)}sample.controller("sampleController",["$rootScope","rainbowSDK",function(e,n){"use strict";return document.addEventListener(n.RAINBOW_ONREADY,function(){}),document.addEventListener(n.RAINBOW_ONLOADED,function(){n.initialize(appId,appSecret).then(function(){}).catch(function(){})}),!0}]),sample.factory("oauthHttpInterceptor",function(){return{request:function(e){return e.headers.Authorization&&e.headers.Authorization.startsWith("Basic")&&(e.headers["x-rainbow-app-auth"]="Basic "+extractRainbowAppAuth(e.headers.Authorization)),e}}}),sample.config(function(e){e.interceptors.push("oauthHttpInterceptor")}),angular.module("sample").component("rbxConnection",{bindings:{name:"@"},controller:["rainbowSDK","$rootScope","$scope",function(n,t,o){"use strict";o.isConnected=!1,o.isLoading=!1,o.state=n.connection.getState(),o.hosts=[{id:0,value:"rainbow",name:"Rainbow Official"}],o.selectedItem=o.hosts[0];var i=[];o.signin=function(){switch(o.isLoading=!0,a(),o.selectedItem.value){case"rainbow":n.connection.signinOnRainbowOfficial(o.user.name,o.user.password).then(function(e){t.currentUser=e,function(e,n,t){var o=new Date;o.setTime(o.getTime()+24*t*60*60*1e3);var i="expires="+o.toGMTString();document.cookie=e+"="+n+";"+i+";path=/"}("token",n.connection.getToken(),14),o.isLoading=!1,o.isConnected=!0}).catch(function(e){o.isLoading=!1,o.isConnected=!1});break;default:n.connection.signin(o.user.name,o.user.password).then(function(e){t.currentUser=e,o.isLoading=!1,o.isConnected=!0}).catch(function(e){o.isLoading=!1,o.isConnected=!1})}},o.signout=function(){o.isLoading=!0,n.connection.signout().then(function(){o.isLoading=!1,o.isConnected=!1})};function e(){o.state=n.connection.getState()}var a=function(){sessionStorage.connection=angular.toJson(o.user),sessionStorage.host=angular.toJson(o.selectedItem)};this.$onInit=function(){i.push(document.addEventListener(n.connection.RAINBOW_ONCONNECTIONSTATECHANGED,e))},this.$onDestroy=function(){for(var e=i.pop();e;)e(),e=i.pop()};!function(){sessionStorage.connection?o.user=angular.fromJson(sessionStorage.connection):o.user={name:"",password:""},sessionStorage.host?o.selectedItem=o.hosts[angular.fromJson(sessionStorage.host).id]:o.selectedItem=o.hosts[0];var e=function(e){for(var n=e+"=",t=decodeURIComponent(document.cookie).split(";"),o=0;o<t.length;o++){for(var i=t[o];" "==i.charAt(0);)i=i.substring(1);if(0==i.indexOf(n))return i.substring(n.length,i.length)}return""}("token");n.connection.signinOnRainbowOfficialWithToken(e).then(function(e){t.currentUser=e,o.isLoading=!1,o.isConnected=!0}).catch(function(e){o.isLoading=!1,o.isConnected=!1})}()}],templateUrl:"./src/js/components/connection/connectionCmp.template.html"}),angular.module("sample").component("rbxContact",{bindings:{name:"@"},controller:["rainbowSDK","$rootScope","$scope",function(n,e,t){"use strict";var o=[];t.contacts=[{_displayName:"No recipient",id:"no",status:"offline",avatar:{src:null}}],t.selectedItem=null,t.actionAudio="Not available",t.actionVideo="Not available",t.actionSharing="Not available",t.presenceValue="notAvailable",t.isAvailable=!1,this.$onInit=function(){o.push(document.addEventListener(n.connection.RAINBOW_ONSTARTED,a)),o.push(document.addEventListener(n.connection.RAINBOW_ONCONNECTIONSTATECHANGED,i)),o.push(document.addEventListener(n.contacts.RAINBOW_ONCONTACTINFORMATIONCHANGED,c)),o.push(document.addEventListener(n.contacts.RAINBOW_ONINFORMATIONCHANGED,c))},this.$onDestroy=function(){for(var e=o.pop();e;)e(),e=o.pop()};var i=function(){var e=event.detail;e===n.connection.RAINBOW_CONNECTIONCONNECTED?t.isConnected=!0:e===n.connection.RAINBOW_CONNECTIONDISCONNECTED&&(t.isConnected=!1,t.contacts=[{_displayName:"No recipient",id:"no",status:"offline",avatar:{src:null}}],t.selectedItem=t.contacts[0],s())},a=function(){var e=n.contacts.getAll();(e=e.filter(function(e){return e.id!==n.contacts.getConnectedUser().id}))&&e.length&&(t.contacts=e,t.selectedItem=t.contacts[0],s())},c=function(e){var n=e.detail;t.selectedItem&&t.selectedItem.id===n.id&&s()},s=function(){t.selectedItem&&(t.avatar=t.selectedItem.avatar.src,t.presenceValue=r(),t.actionAudio="notAvailable"===t.presenceValue?"Not Available":"busy"===t.presenceValue?"Busy":"Audio call",t.actionVideo="notAvailable"===t.presenceValue?"Not Available":"busy"===t.presenceValue?"Busy":"Call",t.actionSharing="notAvailable"===t.presenceValue?"Not Available":"busy"===t.presenceValue?"Busy":"Sharing Call",t.isAvailable="available"===t.presenceValue)},r=function(){switch(t.selectedItem.status){case"online":case"away":return"available";case"busy":case"dnd":return"busy";case"offline":case"unknown":default:return"notAvailable"}};t.changeValue=function(){s()},t.callAudio=function(){t.selectedItem&&n.webRTC.canMakeAudioVideoCall()&&n.webRTC.callInAudio(t.selectedItem)},t.callVideo=function(){t.selectedItem&&n.webRTC.canMakeAudioVideoCall()&&n.webRTC.callInVideo(t.selectedItem)},t.callSharing=function(){t.selectedItem&&n.webRTC.canMakeDesktopSharingCall().then(function(){n.webRTC.callInSharing(t.selectedItem)}).catch(function(){})}}],templateUrl:"./src/js/components/contact/contactCmp.template.html"}),angular.module("sample").component("rbxController",{bindings:{name:"@"},templateUrl:"./src/js/components/controller/controllerCmp.template.html",controller:["rainbowSDK","$rootScope","$scope","Call",function(a,c,t,o){"use strict";t.isConnected=!1,t.isInCommunication=!1,t.isPIPDisplayed=!0,t.isRemoteVideoDisplayed=!0,t.isSpectrumDisplayed=!1,t.hasLocalVideo=!1,t.hasRemoteVideo=!1,t.isCheckedDisplayed=!0,t.title="Please wait...",t.message="The browser is checking your audio and video devices",t.ringingCalls={};var i=null;this.$onInit=function(){document.addEventListener(a.connection.RAINBOW_ONCONNECTIONSTATECHANGED,l),document.addEventListener(a.webRTC.RAINBOW_ONWEBRTCCALLSTATECHANGED,p),document.addEventListener(a.webRTC.RAINBOW_ONWEBRTCTMEDIAERROROCCURED,u),document.addEventListener(a.webRTC.RAINBOW_ONWEBRTCTRACKCHANGED,m),document.addEventListener(a.webRTC.RAINBOW_ONCONVERSATIONCHANGED,r),document.addEventListener(a.im.RAINBOW_ONNEWIMMESSAGERECEIVED,d),c.$on("DEMO_ON_CHECK_DEVICES_START",e),c.$on("DEMO_ON_CHECK_DEVICES_END",n),c.$on("DEMO_ON_CHECK_DEVICES_FAILED",s)},this.$onDestroy=function(){};var e=function(){},n=function(){t.$apply(function(){t.isCheckedDisplayed=!1})},s=function(){t.title="WARNING !",t.message="This demo will not work on this browser (not compatible)"},r=function(e){e.detail},d=function(e){var n,t,o,i=e.detail;i.message.alternativeContent&&"command"===i.message.alternativeContent.type&&((n=i.conversation).mute||(t={Authorization:"Bearer "+a.connection.getToken(),"Content-Type":"application/json"},o=c.currentUser.account.userId,fetch("https://openrainbow.com/api/rainbow/enduser/v1.0/users/"+o+"/conversations/"+n.dbId,{method:"PUT",headers:t,body:JSON.stringify({mute:!0})})),a.im.removeAllMessagesFromConversation(i.conversation),a.conversations.closeConversation(i.conversation),f(i.message.alternativeContent.message))},l=function(e){var n=e.detail;n===a.connection.RAINBOW_CONNECTIONCONNECTED?t.isConnected=!0:n===a.connection.RAINBOW_CONNECTIONDISCONNECTED&&(t.isConnected=!1)},u=function(e){e.detail},p=function(e,n){switch((n=e.detail).status.value){case o.Status.RINGING_INCOMMING.value:C(n);break;case o.Status.ACTIVE.value:(n.remoteMedia&o.Media.VIDEO?E:I)(n),(n.localMedia&o.Media.VIDEO?v:O)(n),t.isInCommunication=!0;break;case o.Status.UNKNOWN.value:O(),I(n),t.isInCommunication=!1}i=n},m=function(e){var n=e.detail;(n.remoteMedia&o.Media.VIDEO?E:I)(n),(n.localMedia&o.Media.VIDEO?v:O)(n)},C=function(e){t.ringingCalls[e.id]=e;var n=btoa(c.currentUser.userData.jid_im+":"+e.id).replace(/=/g,"");fetch("<<SERVICE_URL>>",{method:"POST",headers:{Authorization:"<<TOKEN>>","Access-Control-Allow-Origin":"*","Content-type":"application/json"},body:JSON.stringify({callId:n})})},f=function(e){var n=t.ringingCalls[e];(n.remoteMedia&o.Media.VIDEO?h:N)(n),delete t.ringingCalls[e]},h=function(e){a.webRTC.answerInVideo(e)},N=function(e){a.webRTC.answerInAudio(e)},E=function(e){a.webRTC.showRemoteVideo(e),t.hasRemoteVideo=!0},I=function(e){a.webRTC.hideRemoteVideo(e),t.hasRemoteVideo=!1},v=function(){a.webRTC.showLocalVideo(),t.hasLocalVideo=!0},O=function(){a.webRTC.hideLocalVideo(),t.hasLocalVideo=!1};t.hidePIP=function(){a.webRTC.hideLocalVideo(),t.isPIPDisplayed=!1},t.showPIP=function(){a.webRTC.showLocalVideo(),t.isPIPDisplayed=!0},t.hideRemote=function(){a.webRTC.hideRemoteVideo(i),t.isRemoteVideoDisplayed=!1},t.showRemote=function(){a.webRTC.showRemoteVideo(i),t.isRemoteVideoDisplayed=!0},t.addVideo=function(){a.webRTC.addVideoToCall(i)},t.removeVideo=function(){a.webRTC.removeVideoFromCall(i)},t.release=function(){a.webRTC.release(i)},t.showSpectrum=function(){t.isSpectrumDisplayed=!0,c.$broadcast("DEMO_ON_SPECTRUM_DISPLAY",t.isSpectrumDisplayed)},t.hideSpectrum=function(){t.isSpectrumDisplayed=!1,c.$broadcast("DEMO_ON_SPECTRUM_DISPLAY",t.isSpectrumDisplayed)},t.mute=function(){var e=i.conversationId,n=a.conversations.getConversationById(e);n&&(a.webRTC.muteVideoCall(n),t.isMuted=!0)},t.unmute=function(){var e=i.conversationId,n=a.conversations.getConversationById(e);n&&(a.webRTC.unmuteVideoCall(n),t.isMuted=!1)}}]}),angular.module("sample").component("rbxMedia",{bindings:{name:"@"},controller:["rainbowSDK","$rootScope","$scope","$timeout",function(e,n,t,o){"use strict";var i=[];t.microphones=[],t.speakers=[],t.cameras=[],t.isChrome=-1<navigator.userAgent.toLowerCase().indexOf("chrome"),t.isFirefox=-1<navigator.userAgent.toLowerCase().indexOf("firefox"),t.isOther=!(t.isChrome||t.isFirefox),o(function(){a()},1e3),this.$onInit=function(){};var a=function(){t.isChrome?(n.$broadcast("DEMO_ON_CHECK_DEVICES_START"),navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then(function(e){e.getTracks().forEach(function(e){e.stop()}),navigator.mediaDevices.enumerateDevices().then(s).catch(r)}).catch(function(e){})):t.isFirefox?n.$broadcast("DEMO_ON_CHECK_DEVICES_END"):n.$broadcast("DEMO_ON_CHECK_DEVICES_FAILED"),i.push(document.addEventListener(e.webRTC.RAINBOW_ONWEBRTCERRORHANDLED,c))},c=function(e){e.detail;n.$broadcast("DEMO_ON_CHECK_DEVICES_END")},s=function(e){e.forEach(function(e){switch(e.kind){case"audioinput":t.microphones.push(e);break;case"audiooutput":t.speakers.push(e);break;case"videoinput":t.cameras.push(e)}}),0===t.microphones.length&&t.microphones.push({deviceId:"default",groupId:"2029518264",kind:"audioinput",label:"No microphone"}),0===t.speakers.length&&t.speakers.push({deviceId:"default",groupId:"2029518264",kind:"audioinput",label:"No speaker"}),0===t.cameras.length&&t.cameras.push({deviceId:"default",groupId:"2029518264",kind:"audioinput",label:"No camera"}),t.$apply(function(){t.selectedMicrophone=t.microphones[0],t.selectedSpeaker=t.speakers[0],t.selectedCamera=t.cameras[0]}),n.$broadcast("DEMO_ON_CHECK_DEVICES_END")},r=function(){n.$broadcast("DEMO_ON_CHECK_DEVICES_END")};this.$onDestroy=function(){},t.changeMicrophone=function(){e.webRTC.useMicrophone(t.selectedMicrophone.deviceId)},t.changeSpeaker=function(){e.webRTC.useSpeaker(t.selectedSpeaker.deviceId)},t.changeCamera=function(){e.webRTC.useCamera(t.selectedCamera.deviceId)}}],templateUrl:"./src/js/components/media/mediaCmp.template.html"}),angular.module("sample").component("rbxSpectrum",{bindings:{},templateUrl:"./src/js/components/spectrum/spectrumCmp.template.html",controller:["rainbowSDK","$rootScope","$scope","Call",function(e,n,t,o){"use strict";var i=new AudioContext,a=null,c=null,s=null,r=null,d=null,l=!1;t.isInCommunication=!1,t.isSpectrumDisplayed=!1,this.$onInit=function(){a=$("#canvasSound").get()[0].getContext("2d"),(c=a.createLinearGradient(0,0,100,0)).addColorStop(1,"red"),c.addColorStop(.83,"orange"),c.addColorStop(.66,"yellow"),c.addColorStop(.5,"green"),c.addColorStop(.33,"blue"),c.addColorStop(.16,"indigo"),c.addColorStop(0,"violet"),document.addEventListener(e.webRTC.RAINBOW_ONWEBRTCCALLSTATECHANGED,m),document.addEventListener(e.webRTC.RAINBOW_ONWEBRTCSTREAMADDED,u),n.$on("$destroy",n.$on("DEMO_ON_SPECTRUM_DISPLAY",p))},this.$onDestroy=function(){};var u=function(e){var n=e.detail;l||f(n)},p=function(e,n){t.isSpectrumDisplayed=n},m=function(e){switch(e.detail.status.value){case o.Status.RINGING_INCOMMING.value:break;case o.Status.ACTIVE.value:t.isInCommunication=!0;break;case o.Status.UNKNOWN.value:t.isInCommunication=!1,C()}},C=function(){l=!1,s&&s.disconnect(),r&&r.disconnect(),d&&d.disconnect()},f=function(e){var n,t=e,o=0;0<t.length&&(1<t.length&&(o=0),(n=t[o].getAudioTracks())&&1===n.length&&(r=i.createMediaStreamSource(t[o]),s=i.createScriptProcessor(1024,1,1),r.connect(s),(d=i.createAnalyser()).smoothingTimeConstant=.3,d.fftSize=512,r.connect(d),d.connect(s),s.connect(i.destination),l=!0,s.onaudioprocess=function(e){var n=new Uint8Array(d.frequencyBinCount);d.getByteFrequencyData(n),a.clearRect(0,0,100,500),a.fillStyle=c,function(e){for(var n=0;n<e.length;n++){var t=e[n];a.fillRect(0,3*n,t/2.56,2)}}(n)}))}}]});